<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="google-site-verification" content="VqJldDq5XrPqnNzHvKs9TWuIjGeMA5tLkgDbUY587gM" />
    <title>AI Image to Text Conversion</title>
    <!-- Link to Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            font-family: 'Arial', sans-serif;
            background-color: #f9f9f9;
            margin: 0;
            padding: 0;
        }
        .navbar {
            background: transparent;
            background: #fff;
        }
        .navbar-brand {
            font-weight: bold;
            font-size: 1.5rem;
        }
        .hero {
            text-align: center;
            padding: 100px 20px;
            background: #fff;
        }
        .hero h1 {
            font-size: 2.5rem;
            font-weight: bold;
            margin-bottom: 10px;
        }
        .hero p {
            font-size: 1.2rem;
            margin-bottom: 30px;
        }
        .btn-primary {
            background-color: #000;
            border: none;
            padding: 10px 30px;
            font-size: 1rem;
            border-radius: 5px;
        }
        .upload-section {
            text-align: center;
            margin-top: 30px;
        }
        .download-buttons {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-top: 20px;
        }
        .btn-secondary {
            background-color: #ccc;
            color: #000;
            border: none;
            padding: 10px 20px;
            font-size: 0.9rem;
            border-radius: 5px;
            cursor: not-allowed;
        }
        .btn-secondary.active {
            background-color: #007bff;
            color: #fff;
            cursor: pointer;
        }
        #imagePreview {
            margin-top: 20px;
            max-width: 100%;
            height: auto;
        }
        /* Force Select2 to look like Bootstrap form-control */
.select2-container--default .select2-selection--single {
    background-color: #fff !important;
    border: 1px solid #ced4da !important;
    border-radius: 0.375rem !important;
    height: 38px !important;
    padding: 6px 12px !important;
    font-size: 1rem !important;
    color: #495057 !important;
    display: flex !important;
    align-items: center !important;
    box-shadow: none !important;
    transition: border-color .15s ease-in-out, box-shadow .15s ease-in-out !important;
}

/* When selected / focused */
.select2-container--default.select2-container--focus .select2-selection--single {
    border-color: #86b7fe !important;
    box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.25) !important;
}

/* Text inside select2 box */
.select2-selection__rendered {
    padding-left: 0px !important;
    line-height: 1.5 !important;
    color: #495057 !important;
}

/* Arrow positioning */
.select2-selection__arrow {
    height: 100% !important;
    top: 0px !important;
    right: 10px !important;
}

/* Ensure full width */
.select2-container {
    width: 100% !important;
}

/* Optional: Match dropdown highlight */
.select2-container--default .select2-results__option--highlighted[aria-selected] {
    background-color: #000 !important;
    color: #fff !important;
}

/* Style the Select2 placeholder to be bold and black */
.select2-container--default .select2-selection--single .select2-selection__rendered {
    font-weight: bold !important;
    color: #000 !important;
}
#languageSelect {
    margin-bottom: 30px !important; /* custom space */
}

.select2-container--default .select2-selection--single .select2-selection__placeholder {
    color: #000 !important;
    font-weight: bold;
}


    </style>
    <!-- jQuery (required by Select2) -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

<!-- Select2 CSS and JS -->
<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>

</head>
<body>

    <nav class="navbar navbar-expand-lg bg-body-tertiary">
        <div class="container-fluid">
            <!-- Left-aligned brand -->
            <a class="navbar-brand p-2" href="/">IMAGE2TEXT</a>
            <button class="btn btn-dark mx-2">
                <a href="/history" class="text-light" style="text-decoration: none;">History</a>
            </button>
    
            <!-- Right-aligned buttons -->
            <div class="d-flex ms-auto">
                <button class="btn btn-dark mx-2">
                    <a href="/" class="text-light" style="text-decoration: none;">Home</a>
                </button>
                {% if 'user_id' in session %}
                <button class="btn btn-dark mx-2">
                    <a href="/logout" class="text-light" style="text-decoration: none;">Logout</a>
                </button>
                {% else %}
                <button class="btn btn-dark mx-2">
                    <a href="/login" class="text-light" style="text-decoration: none;">Login</a>
                </button>
                <button class="btn btn-dark mx-2">
                    <a href="/register" class="text-light" style="text-decoration: none;">Register</a>
                </button>
                {% endif %}
            </div>
        </div>
    </nav>
    

    <section class="hero">
        <h1>Capture & Convert with AI</h1>
        <p>The ultimate text conversion experience in multiple languages.</p>
        <div class="upload-section">
            <form id="uploadForm" enctype="multipart/form-data">
                <input type="file" id="imageInput" name="image" accept="image/*" class="form-control mb-3" required>
                <select name="language" id="languageSelect" class="form-control mb-3" required>
    <option value="" disabled selected >Select a language present in the image</option>
    <option value="afr">Afrikaans</option>
    <option value="amh">Amharic</option>
    <option value="ara">Arabic</option>
    <option value="asm">Assamese</option>
    <option value="aze">Azerbaijani</option>
    <option value="bel">Belarusian</option>
    <option value="ben">Bengali</option>
    <option value="bod">Tibetan</option>
    <option value="bos">Bosnian</option>
    <option value="bul">Bulgarian</option>
    <option value="cat">Catalan</option>
    <option value="ceb">Cebuano</option>
    <option value="ces">Czech</option>
    <option value="chi_sim">Chinese (Simplified)</option>
    <option value="chi_tra">Chinese (Traditional)</option>
    <option value="chr">Cherokee</option>
    <option value="dan">Danish</option>
    <option value="deu">German</option>
    <option value="dzo">Dzongkha</option>
    <option value="ell">Greek</option>
    <option value="eng">English</option>
    <option value="enm">English (Old)</option>
    <option value="epo">Esperanto</option>
    <option value="est">Estonian</option>
    <option value="eus">Basque</option>
    <option value="fas">Persian</option>
    <option value="fin">Finnish</option>
    <option value="fra">French</option>
    <option value="frk">Frankish</option>
    <option value="frm">French (Old)</option>
    <option value="gle">Irish</option>
    <option value="glg">Galician</option>
    <option value="grc">Greek (Ancient)</option>
    <option value="guj">Gujarati</option>
    <option value="hat">Haitian</option>
    <option value="heb">Hebrew</option>
    <option value="hin">Hindi</option>
    <option value="hrv">Croatian</option>
    <option value="hun">Hungarian</option>
    <option value="iku">Inuktitut</option>
    <option value="ind">Indonesian</option>
    <option value="isl">Icelandic</option>
    <option value="ita">Italian</option>
    <option value="jav">Javanese</option>
    <option value="jpn">Japanese</option>
    <option value="kan">Kannada</option>
    <option value="kat">Georgian</option>
    <option value="kaz">Kazakh</option>
    <option value="khm">Khmer</option>
    <option value="kir">Kyrgyz</option>
    <option value="kor">Korean</option>
    <option value="kur">Kurdish</option>
    <option value="lao">Lao</option>
    <option value="lat">Latin</option>
    <option value="lav">Latvian</option>
    <option value="lit">Lithuanian</option>
    <option value="mal">Malayalam</option>
    <option value="mar">Marathi</option>
    <option value="mkd">Macedonian</option>
    <option value="mlt">Maltese</option>
    <option value="msa">Malay</option>
    <option value="mya">Burmese</option>
    <option value="nep">Nepali</option>
    <option value="nld">Dutch</option>
    <option value="nor">Norwegian</option>
    <option value="ori">Odia</option>
    <option value="pan">Punjabi</option>
    <option value="pol">Polish</option>
    <option value="por">Portuguese</option>
    <option value="pus">Pashto</option>
    <option value="ron">Romanian</option>
    <option value="rus">Russian</option>
    <option value="san">Sanskrit</option>
    <option value="sin">Sinhala</option>
    <option value="slk">Slovak</option>
    <option value="slv">Slovenian</option>
    <option value="spa">Spanish</option>
    <option value="sqi">Albanian</option>
    <option value="srp">Serbian</option>
    <option value="swa">Swahili</option>
    <option value="swe">Swedish</option>
    <option value="syr">Syriac</option>
    <option value="tam">Tamil</option>
    <option value="tel">Telugu</option>
    <option value="tgk">Tajik</option>
    <option value="tgl">Tagalog</option>
    <option value="tha">Thai</option>
    <option value="tir">Tigrinya</option>
    <option value="tur">Turkish</option>
    <option value="uig">Uyghur</option>
    <option value="ukr">Ukrainian</option>
    <option value="urd">Urdu</option>
    <option value="uzb">Uzbek</option>
    <option value="vie">Vietnamese</option>
    <option value="yid">Yiddish</option>
</select>
<br>
<br>
<br>
<br>
                <button type="submit" id="convertButton" class="btn btn-primary" >Convert</button>
            </form>
            <!-- Image preview section -->
            <div id="imagePreviewSection" class="mt-3" style="display: none;">
                <h3>Uploaded Image:</h3>
                <img id="imagePreview" alt="Uploaded Image" />
            </div>
        </div>
        <div id="outputMessage" class="mt-3 text-muted"></div>
        <div id="outputText" class="mt-3 text-primary"></div>
        
        <div class="download-buttons">
            
            <button id="downloadWord" class="btn btn-dark" disabled>Download Word</button>
        </div>
    </section>

    <div class="container text-center my-5">
        <h1 class="fw-bold">Extract Text from Image</h1>
        <p class="text-muted fs-3">OCR (Optical Character Recognition) is a technology that extracts text from images and converts it into machine-readable format. It is widely used for digitizing documents, improving accessibility for people with visual impairments, and automating data entry tasks in business settings.</p>
        <br>
        <br>
        <h2 class="my-6 fw-bold mt-3">How to Use Extract Text from Image?</h2>
        <p class="fs-3  text-muted">Here is a step-by-step guide on how to use our extract text from image tool:</p>
    
        <div class="row text-center mt-5">
          <div class="col-md-4">
            <div class="card border-0">
              <div class="card-body">
                <img src="https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcSzumSx8WAxflUee-a2GFGKEE2l5r_KKZi7VQ&s" alt="Upload Image" class="mb-3 img-fluid rounded">
                <h5 class="fw-bold">Upload Image</h5>
                <p class="text-muted">Upload the image from which you want to extract the text.</p>
              </div>
            </div>
          </div>
    
          <div class="col-md-4">
            <div class="card border-0">
              <div class="card-body">
                <img src="https://s.smallpdf.com/static/cms/f/102628/400x320/9376ba427c/how-to-do-ocr-on-pdf-for-free.png" alt="Run the Tool" class="mb-3 img-fluid">
                <h5 class="fw-bold">Run the Tool</h5>
                <p class="text-muted">To start image text extraction, run the image text extractor by clicking the <b>convert</b> button.</p>
              </div>
            </div>
          </div>

          <div class="col-md-4">
            <div class="card border-0">
              <div class="card-body">
                <img src="https://play-lh.googleusercontent.com/7ZOGhiRcfGyNYkiqq3YBUeuqCnUkRDNucguJBrV-ri1o-8CJa3eNolAcKBTDotMnqBtM" alt="Download/Copy Text" class="mb-3 img-fluid img-rounded">
                <h5 class="fw-bold">Download/Copy Text</h5>
                <p class="text-muted">After conversion, the tool will provide you with digital text that you can either <b>Text</b> or <b>Download word document</b>.</p>
              </div>
            </div>
          </div>
        </div>
      </div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/tesseract.js@5.0.3/dist/tesseract.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
// 🔧 Image preprocessing function: grayscale + basic sharpening
async function preprocessImage(dataUrl) {
    return new Promise(resolve => {
        const img = new Image();
        img.onload = () => {
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            canvas.width = img.width;
            canvas.height = img.height;

            ctx.drawImage(img, 0, 0);
            let imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
            let data = imageData.data;

            // Grayscale conversion
            for (let i = 0; i < data.length; i += 4) {
                let avg = (data[i] + data[i+1] + data[i+2]) / 3;
                data[i] = data[i+1] = data[i+2] = avg;
            }

            // Apply simple sharpening kernel
            imageData = applyConvolution(imageData, canvas.width, canvas.height, [
                0, -1,  0,
               -1,  5, -1,
                0, -1,  0
            ]);

            ctx.putImageData(imageData, 0, 0);
            resolve(canvas.toDataURL());
        };
        img.src = dataUrl;
    });
}

// 🔧 Convolution kernel (used for sharpening)
function applyConvolution(imageData, width, height, weights) {
    const output = new ImageData(width, height);
    const side = Math.round(Math.sqrt(weights.length));
    const halfSide = Math.floor(side / 2);

    for (let y = 0; y < height; y++) {
        for (let x = 0; x < width; x++) {
            let r = 0, g = 0, b = 0;

            for (let dy = 0; dy < side; dy++) {
                for (let dx = 0; dx < side; dx++) {
                    const sy = y + dy - halfSide;
                    const sx = x + dx - halfSide;
                    if (sy >= 0 && sy < height && sx >= 0 && sx < width) {
                        const offset = ((sy * width) + sx) * 4;
                        const weight = weights[dy * side + dx];
                        r += imageData.data[offset] * weight;
                        g += imageData.data[offset + 1] * weight;
                        b += imageData.data[offset + 2] * weight;
                    }
                }
            }

            const i = (y * width + x) * 4;
            output.data[i] = Math.min(Math.max(r, 0), 255);
            output.data[i+1] = Math.min(Math.max(g, 0), 255);
            output.data[i+2] = Math.min(Math.max(b, 0), 255);
            output.data[i+3] = 255;
        }
    }

    return output;
}

// 🔍 Send text to Flask for health data extraction
async function extractHealthDataFromText(text) {
    const response = await fetch('/extract_health_data', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ text })
    });
    const healthData = await response.json();
    renderHealthTable(healthData);
}

// 📥 OCR flow begins on image upload
document.getElementById('uploadForm').addEventListener('submit', async function (e) {
    e.preventDefault();
    const imageInput = document.getElementById('imageInput');
    const selectedLanguage = document.querySelector('select[name="language"]').value;
    const imageFile = imageInput.files[0];

    if (!imageFile) {
        alert("Please select an image");
        return;
    }

    document.getElementById('outputMessage').innerText = 'Extracting text... Please wait.';
    document.getElementById('convertButton').disabled = true;

    const reader = new FileReader();
    reader.onload = async function () {
        const rawImageData = reader.result;

        // ✅ Preprocess the image before OCR
        const preprocessedImage = await preprocessImage(rawImageData);

        // ✅ Run Tesseract.js with custom config (oem 1, psm 6)
        const { data: { text } } = await Tesseract.recognize(preprocessedImage, selectedLanguage, {
            logger: m => console.log(m),
            config: {
                tessedit_ocr_engine_mode: "1",    // --oem 1
                tessedit_pageseg_mode: "6"        // --psm 6
            }
        });

        document.getElementById('outputMessage').innerText = '';
        document.getElementById('outputText').innerText = text;
        extractHealthDataFromText(text);

        // ✅ Save to Flask backend (history)
        fetch('/save_extracted_text', {
            method: 'POST',
            credentials: 'same-origin',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded'
            },
            body: new URLSearchParams({ text })
        });

        if (text) {
            enableDownloadButtons({ text });
        } else {
            disableDownloadButtons();
        }

        document.getElementById('convertButton').disabled = false;
    };
    reader.readAsDataURL(imageFile);
});

// ⬇️ Word download button
function enableDownloadButtons(data) {
    const downloadBtn = document.getElementById('downloadWord');
    downloadBtn.classList.add('active');
    downloadBtn.disabled = false;
    downloadBtn.onclick = () => {
        fetch('/image_text_to_word', {
            method: 'POST',
            credentials: 'same-origin',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded'
            },
            body: new URLSearchParams({ text: data.text }),
        })
        .then(response => response.blob())
        .then(blob => {
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'output_text.docx';
            a.click();
        });
    };
}

function disableDownloadButtons() {
    const downloadBtn = document.getElementById('downloadWord');
    downloadBtn.classList.remove('active');
    downloadBtn.disabled = true;
}

// 🖼️ Image preview logic
document.getElementById('imageInput').addEventListener('change', function(event) {
    const file = event.target.files[0];
    if (file) {
        const reader = new FileReader();
        reader.onload = function(e) {
            document.getElementById('imagePreview').src = e.target.result;
            document.getElementById('imagePreviewSection').style.display = 'block';
        };
        reader.readAsDataURL(file);
    }
});


    $(document).ready(function () {
        $('#languageSelect').select2({
            placeholder: "Select a language",
            width: '100%'
        });
    });


</script>



</body>
</html>
